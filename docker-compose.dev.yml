############################################################
# Docker Compose for APILog Dev Environment
# APILog 개발 환경용 Docker Compose
############################################################

services:
  ############################################################
  # 1) InfluxDB 3 Core
  #    Time-series DB (HTTP API on port 8181)
  #    시계열 데이터베이스 (8181 포트에서 API 제공)
  ############################################################
  influxdb3-core:
    image: influxdb:3-core
    container_name: influxdb3-core

    environment:
      # Required configuration parameters --------------------
      # 반드시 필요한 환경 변수 설정 --------------------------
      #
      # Storage type: local filesystem
      # 스토리지 타입: 로컬 파일 시스템
      INFLUXDB3_OBJECT_STORE: file

      # Data directory (persisted to volume)
      # 데이터 디렉터리 (볼륨에 영구 저장)
      INFLUXDB3_DB_DIR: /var/lib/influxdb3

      # Node ID (required argument)
      # 노드 ID (필수 인자)
      INFLUXDB3_NODE_ID: influx-node0

      # Log level
      # 로그 레벨
      LOG_FILTER: info

      # Disable authentication for development convenience
      # 개발 환경에서는 인증을 끄고 편하게 사용
      INFLUXDB3_START_WITHOUT_AUTH: "true"

    command:
      # Explicitly provide --node-id because image entrypoint needs it
      # 이미지의 entrypoint가 --node-id를 필수로 요구하므로 명시적으로 지정
      - influxdb3
      - serve
      - --log-filter
      - info
      - --without-auth
      - --object-store
      - file
      - --plugin-dir
      - /plugins
      - --node-id
      - influx-node0

    ports:
      - "8181:8181"   # Host 8181 → Container 8181 (HTTP API)
                      # 호스트 8181 포트를 InfluxDB API에 매핑

    volumes:
      # Database / catalog / parquet storage
      # 데이터베이스, 카탈로그, 파케 저장 볼륨
      - influx-data:/var/lib/influxdb3

      # Home metadata for influxdb3 user
      # influxdb3 유저 홈 메타데이터
      - influx-meta:/home/influxdb3/.influxdb3

      # Plugins directory (rollups, custom scripts)
      # 플러그인 저장소 (롤업, 커스텀 스크립트)
      - influx-plugins:/plugins

    restart: unless-stopped


  ############################################################
  # 2) InfluxDB 3 Explorer (Web UI)
  #    Manage DBs, tokens, and run queries (port 8888)
  #    데이터베이스, 토큰 관리 및 쿼리 실행용 UI (8888 포트)
  ############################################################
    ############################################################
  # 2) InfluxDB 3 Explorer (웹 UI)
  ############################################################
  influxdb3-explorer:
    image: influxdata/influxdb3-ui:1.3.0
    container_name: influxdb3-explorer
    command: ["--mode=admin"]
    ports:
      - "8888:80"
    environment:
      SESSION_SECRET_KEY: "dev-secret-change-me"

    volumes:
      - explorer-data:/db
      - ./examples/influxdb3-explorer/config:/app-root/config:ro
    depends_on:
      - influxdb3-core
    restart: unless-stopped


  ############################################################
  # 3) apilog-api (FastAPI backend)
  #    Event ingestion & query API for APILog
  #    APILog의 이벤트 수집 및 조회용 백엔드 API
  ############################################################
  apilog-api:
    container_name: apilog-api
    build: ./back/app

    environment:
      INFLUX_URL: http://influxdb3-core:8181
      INFLUX_TOKEN: apilog-dev-token
      INFLUX_ORG: ${INFLUX_ORG}
      INFLUX_BUCKET: ${INFLUX_DATABASE}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
      LLM_PROVIDER: ${LLM_PROVIDER}
      LLM_ENDPOINT: ${LLM_ENDPOINT}
      LLM_MODEL: ${LLM_MODEL}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE}
      LLM_TIMEOUT_S: ${LLM_TIMEOUT_S}

    depends_on:
      - influxdb3-core
      - ollama

    expose:
      - "8000"

    volumes:
      - snapshots:/snapshots

    restart: unless-stopped


  ############################################################
  # 4) apilog-nginx (Frontend + Reverse Proxy)
  #    프론트엔드 정적파일 서빙 및 API 프록시
  ############################################################
  apilog-nginx:
    container_name: apilog-nginx
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - apilog-api
    restart: unless-stopped


  ############################################################
  # 5) dummy-frontend (Test site)
  #    개발 중 이벤트 수집 테스트용 웹사이트
  ############################################################
  dummy-frontend:
    build:
      context: ./examples/dummy-frontend
      dockerfile: Dockerfile
    container_name: dummy-frontend
    ports:
      - "80:3000"
    environment:
      NODE_ENV: production
    restart: unless-stopped

  ############################################################
  # 7) ollama (Local LLM Server)
  #    AI 모델 로컬 인퍼런스 서버 (포트 11434)
  ############################################################
  ollama:
    image: ollama/ollama:latest
    container_name: ollama

    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_KEEP_ALIVE=1h

    ports:
      - "11434:11434"

    volumes:
      - ollama-data:/root/.ollama

    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 20

    restart: unless-stopped

    # GPU 환경이면 아래 주석 해제해서 GPU 사용 가능
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - capabilities: ["gpu"]

##############################################################
# Named Volumes
# (영구 데이터 저장소)
##############################################################
volumes:
  influx-data:
  influx-meta:
  influx-plugins:
  explorer-data:
  snapshots:
  ollama-data:
