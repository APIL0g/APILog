# Docker Compose for APILog Dev Environment
# APILog 개발/테스트 환경용 Docker Compose 설정
############################################################

services:
  ############################################################
  # 1) InfluxDB 3 Core (dev)
  #    Time-series DB (HTTP API on port 8181)
  #    시간 기반 데이터 저장소 (포트 8181)
  ############################################################
  influxdb3-core:
    image: influxdb:3-core
    container_name: influxdb3-core

    environment:
      # Storage type: local filesystem
      # 스토리지 타입: 로컬 파일 시스템
      INFLUXDB3_OBJECT_STORE: file

      # Data directory (persisted to volume)
      # 데이터 디렉터리 (볼륨에 영속 저장)
      INFLUXDB3_DB_DIR: /var/lib/influxdb3

      # Node ID (required argument)
      # 노드 ID (필수 인자)
      INFLUXDB3_NODE_ID: influx-node0

      # Log level
      # 로그 레벨
      LOG_FILTER: info

      # Disable authentication for development convenience
      # 개발 편의를 위해 인증 비활성화
      INFLUXDB3_START_WITHOUT_AUTH: "true"

    command:
      - influxdb3
      - serve
      - --log-filter
      - info
      - --without-auth
      - --object-store
      - file
      - --plugin-dir
      - /plugins
      - --node-id
      - influx-node0

    # Host 8181 -> Container 8181 (HTTP API)
    # 호스트 8181 포트를 컨테이너 8181로 매핑
    ports:
      - "8181:8181"

    volumes:
      # Database / catalog / parquet storage
      # DB / 카탈로그 / Parquet 데이터 저장
      - influx-data:/var/lib/influxdb3
      # Home metadata for influxdb3 user
      # influxdb3 사용자 홈 디렉터리
      - influx-meta:/home/influxdb3/.influxdb3
      # Plugins directory (rollups, custom scripts)
      # 플러그인/커스텀 스크립트 디렉터리
      - influx-plugins:/plugins

    restart: unless-stopped


  ############################################################
  # 2) InfluxDB 3 Explorer (Web UI)
  #    Manage DBs, tokens, and run queries (port 8888)
  #    DB/토큰 관리 및 쿼리 실행을 위한 웹 UI (포트 8888)
  ############################################################
  influxdb3-explorer:
    image: influxdata/influxdb3-ui:1.3.0
    container_name: influxdb3-explorer

    command: ["--mode=admin"]

    # Host 8888 -> Explorer UI
    # 호스트 8888 포트를 UI로 노출
    ports:
      - "8888:80"

    volumes:
      - explorer-data:/db
      - ./examples/influxdb3-explorer/config:/app-root/config:ro

    depends_on:
      - influxdb3-core

    restart: unless-stopped


  ############################################################
  # 3) apilog-api (FastAPI backend)
  #    Event ingestion & query API for APILog
  #    이벤트 수집 및 조회를 처리하는 FastAPI 백엔드
  ############################################################
  apilog-api:
    container_name: apilog-api
    build: ./back/app

    environment:
      # Influx endpoint for dev API
      # 개발용 Influx 연결 정보
      INFLUX_URL: ${INFLUX_URL}
      INFLUX_TOKEN: apilog-dev-token
      INFLUX_DATABASE: apilog_db
      # CORS / LLM / AI widgets
      # CORS 및 LLM/AI 위젯 관련 설정
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN}
      LLM_PROVIDER: ${LLM_PROVIDER}
      LLM_ENDPOINT: ${LLM_ENDPOINT}
      LLM_MODEL: ${LLM_MODEL}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE}
      LLM_TIMEOUT_S: ${LLM_TIMEOUT_S}
      AI_INSIGHTS_CACHE_TTL: ${AI_INSIGHTS_CACHE_TTL}
      AI_INSIGHTS_EXPLAIN_CACHE_TTL: ${AI_INSIGHTS_EXPLAIN_CACHE_TTL}
      AI_REPORT_FETCH_BASE: ${AI_REPORT_FETCH_BASE}
      TARGET_SITE_BASE_URL: http://dummy-frontend:3000
      LLM_API_KEY: ${LLM_API_KEY}


    depends_on:
      - influxdb3-core
      - ollama

    # Only exposed inside the compose network (Nginx proxies this)
    # compose 내부에서만 노출 (Nginx가 프록시)
    ports:
      - "8000:8000"

    volumes:
      # Store generated heatmap snapshots
      # 생성된 히트맵 스냅샷 저장
      - snapshots:/snapshots

    restart: unless-stopped


  ############################################################
  # 4) apilog-nginx (Frontend + Reverse Proxy)
  #    Serves dashboard UI + proxies API
  #    대시보드 UI 제공 및 API 리버스 프록시
  ############################################################
  apilog-nginx:
    container_name: apilog-nginx
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile

    # Host 10000 -> Container 80 (change if collision)
    # 호스트 10000 포트 사용 (충돌 시 수정)
    ports:
      - "10000:80"

    depends_on:
      - apilog-api

    restart: unless-stopped


  ############################################################
  # 5) dummy-frontend (Test site)
  #    Sample site for heatmap/snapshot testing
  #    히트맵/스냅샷 테스트용 샘플 사이트
  ############################################################
  dummy-frontend:
    build:
      context: ./examples/dummy-frontend
      dockerfile: Dockerfile
    container_name: dummy-frontend

    # Host 80 -> Container 3000 (accessible in browser)
    # 호스트 80 포트를 컨테이너 3000에 매핑 (브라우저 접근)
    ports:
      - "80:3000"

    environment:
      NODE_ENV: production

    restart: unless-stopped


  ############################################################
  # 6) ollama (Local LLM Server)
  #    Local LLM endpoint for dev widgets
  #    개발 환경용 로컬 LLM 서버
  ############################################################
  ollama:
    image: ollama/ollama:latest
    container_name: ollama

    environment:
      OLLAMA_HOST: 0.0.0.0
      OLLAMA_KEEP_ALIVE: 1h
      # Fallback model if not set via .env
      # .env에 없으면 llama3:8b 사용
      LLM_MODEL: ${LLM_MODEL:-llama3:8b}

    # Expose Ollama publicly for dev convenience
    # 개발 편의를 위해 호스트에 노출
    ports:
      - "11434:11434"

    volumes:
      - ollama-data:/root/.ollama

    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Bootstrapping Ollama model: $LLM_MODEL"
        ollama serve &
        PID=$!
        sleep 10
        if [ -n "$LLM_MODEL" ]; then
          ollama pull "$LLM_MODEL" || echo "Warning: failed to pull $LLM_MODEL"
        fi
        wait $PID

    restart: unless-stopped
    gpus: all


##############################################################
# Named Volumes (persistent data)
# 영속 데이터를 위한 볼륨 정의
##############################################################
volumes:
  influx-data:
  influx-meta:
  influx-plugins:
  explorer-data:
  snapshots:
  ollama-data:
